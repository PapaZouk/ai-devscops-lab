name: Reusable AI Security Fixer

on:
  workflow_call:
    inputs:
      vulnerability_description:
        required: true
        type: string
      llm_url:
        required: true
        type: string
      llm_model_name:
        required: true
        type: string
    secrets:
      LM_API_KEY:
        required: true

jobs:
  api-patch:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ai-tools/ai-safety-orchestrator

    steps:
      - name: Checkout Target (Vulnerable) Repo
        uses: actions/checkout@v4
        with:
          path: target-repo 

      - name: Checkout AI Tools Repo
        uses: actions/checkout@v4
        with:
          repository: PapaZouk/ai-devscops-lab
          path: ai-tools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install Dependencies
        run: npm install

      - name: Build MCP Server
        run: |
          cd ../mcp-security-server
          npm install
          npm run build

      - name: Run AI Fixer
        run: |
          TARGET_PATH="${{ github.workspace }}/target-repo"
          
          npx tsx src/main.ts \
            --agent=security \
            --target=$TARGET_PATH \
            --input="${{ inputs.vulnerability_description }}"
        env:
          LM_API_KEY: ${{ secrets.LM_API_KEY }}   
          LM_BASE_URL: ${{ inputs.llm_url }}
          LM_MODEL_NAME: ${{ inputs.llm_model_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CWD: "${{ github.workspace }}/target-repo"
          SKILLS_PATH: "${{ github.workspace }}/ai-tools/ai-safety-orchestrator/skills"
          NODE_ENV: production