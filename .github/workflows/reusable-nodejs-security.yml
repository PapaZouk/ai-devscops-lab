name: Reusable AI Security Fixer

on:
  workflow_call:
    inputs:
      vulnerability_description:
        required: true
        type: string
      llm_url:
        required: true
        type: string
      llm_model_name:
        required: true
        type: string
    secrets:
      LM_API_KEY:
        required: true

jobs:
  api-patch:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ai-tools/ai-safety-orchestrator

    steps:
      - name: Checkout Target (Vulnerable) Repo
        uses: actions/checkout@v4
        with:
          path: target-repo 

      - name: Checkout AI Tools Repo
        uses: actions/checkout@v4
        with:
          repository: PapaZouk/ai-devscops-lab
          path: ai-tools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install Dependencies
        run: npm install

      - name: Install and Build Tools
        run: |
          # 1. Install dependencies for the orchestrator
          npm install
          
          # 2. Build the MCP Security Server so the orchestrator can find build/index.js
          # We move to that directory, install its specific needs, and build it.
          cd ../mcp-security-server
          npm install
          npm run build
          
          # 3. Return to the orchestrator directory for the next step
          cd ../ai-safety-orchestrator

      - name: Run AI Fixer
        run: |
          npx tsx src/main.ts \
            --agent=security \
            --target=${{ github.workspace }}/target-repo \
            --input="${{ inputs.vulnerability_description }}"
        env:
          API_API_KEY: ${{ secrets.LM_API_KEY }}   
          LLMSTUDIO_URL: ${{ inputs.llm_url }}
          LM_MODEL_NAME: ${{ inputs.llm_model_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}