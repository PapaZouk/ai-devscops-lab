name: Reusable AI Security Fixer

on:
  workflow_call:
      inputs:
        vulnerability_description:
          required: true
          type: string
        node_version:
          required: false
          default: '20.x'
          type: string
      secrets:
        API_API_KEY:
          required: true
        LLMSTUDIO_URL:
          required: true

jobs:
  api-patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          path: target-repo

      - name: Checkout DevScops Lab Repository
        uses: actions/checkout@v4
        with:
          repository: PapaZouk/ai-devscops-lab
          path: ai-tools

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
      
      - name: Instal AI DevScops Tools
        run: |
          cd ai-tools/ai-safety-orchestrator
          npm install
      
      - name: Configure Git Identity
        run: |
          git config --global user.name "ai-devscops-bot"
          git config --global user.email "rafexpapala@gmail.com"
      
      - name: Run Orchestrator
        run: |
          cd ai-tools/ai-safety-orchestrator
          npx tsx src/main.ts \
            --agent=security \
            --target=. \
            --input="${{ inputs.vulnerability_description }}"
        env:
          API_API_KEY: ${{ secrets.API_API_KEY }}
          LLMSTUDIO_URL: ${{ secrets.LLMSTUDIO_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
